<!-- templates/profile.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ user }} â€” Profile</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background: #071022; color: #eef6ff; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
      .container { max-width: 1000px; }
      .card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); }
      .handle { font-weight:700; font-size:1.15rem; color:#a8d1ff; text-decoration:none; }
      .muted { color: #98a0ad; }
      .btn-accent { background: linear-gradient(90deg,#3b82f6,#06b6d4); color:#06202b; font-weight:700; border: none; }
      .btn-outline-light { color: #eef6ff; border: 1px solid rgba(255,255,255,0.08); background: transparent; }
      .list-handle { text-decoration:none; color:inherit; }
      .small-muted { color:#98a0ad; font-size:.9rem; }
      .post { padding:10px; border-radius:8px; background: rgba(255,255,255,0.015); margin-bottom:10px; }
      .img-fluid { max-width: 100%; border-radius: 8px; margin-top: 8px; }
      .actions { display:flex; gap:8px; align-items:center; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <div class="handle">{{ user }}</div>
          <div class="muted">{{ record.get('bio','') }}</div>
          <div class="small-muted mt-1">Joined: {{ record.get('created','-') }}</div>
        </div>

        <div id="profileActions" class="actions">
          <a href="{{ url_for('feed') }}" class="btn btn-sm btn-outline-light">Back to feed</a>

          {% set me = session.get('user') %}
          {% if me and me != user %}
            <a href="{{ url_for('chat', user=user) }}" class="btn btn-sm btn-outline-light">Message</a>
            {% set is_following = (me in (record.get('followers') or [])) %}
            <button id="followBtn" data-user="{{ user }}" class="btn btn-sm {{ 'btn-outline-light' if is_following else 'btn-accent' }}" data-following="{{ '1' if is_following else '0' }}">
              {{ 'Unfollow' if is_following else 'Follow' }}
            </button>
          {% elif not me %}
            <a href="{{ url_for('login') }}" class="btn btn-sm btn-accent">Sign in to interact</a>
          {% else %}
            <a href="{{ url_for('edit_profile') }}" class="btn btn-sm btn-outline-light">Edit profile</a>
          {% endif %}
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="h5 mb-0">{{ (record.get('stats') or {}).get('posts', 0) }}</div>
                <div class="small-muted">Posts</div>
              </div>
              <div>
                <div class="h5 mb-0" id="followersCount">{{ (record.get('followers') | length) }}</div>
                <div class="small-muted">Followers</div>
              </div>
              <div>
                <div class="h5 mb-0" id="followingCount">{{ (record.get('following') | length) }}</div>
                <div class="small-muted">Following</div>
              </div>
            </div>

            <hr class="bg-secondary" />

            <div>
              <div class="mb-2"><strong>Followers</strong></div>
              <div id="followersList">
                {% for f in record.get('followers', []) %}
                  <div><a class="list-handle" href="{{ url_for('profile', user=f) }}">{{ f }}</a></div>
                {% else %}
                  <div class="muted">No followers yet</div>
                {% endfor %}
              </div>
            </div>

            <hr class="bg-secondary" />

            <div>
              <div class="mb-2"><strong>Following</strong></div>
              <div id="followingList">
                {% for f in record.get('following', []) %}
                  <div><a class="list-handle" href="{{ url_for('profile', user=f) }}">{{ f }}</a></div>
                {% else %}
                  <div class="muted">Not following anyone</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="card p-3">
            <h6>About</h6>
            <div class="muted">{{ record.get('bio','No bio yet') }}</div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card p-3 mb-3">
            <h5>Recent posts</h5>
            <div class="mt-3">
              {% for p in posts %}
                <div class="post">
                  <div class="d-flex justify-content-between">
                    <div class="small-muted">{{ p.time }}</div>
                    <div class="muted">{{ p.user }}</div>
                  </div>
                  <div class="mt-2">{{ p.text }}</div>
                  {% if p.image %}
                    <div class="mt-2"><img src="{{ url_for('uploaded_file', filename=p.image) }}" alt="post image" class="img-fluid" /></div>
                  {% endif %}
                </div>
              {% else %}
                <div class="muted">No posts yet</div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const btn = document.getElementById('followBtn');
        if(!btn) return;

        btn.addEventListener('click', async function(){
          const target = btn.dataset.user;
          const following = btn.dataset.following === '1';
          const url = following ? `/unfollow/${encodeURIComponent(target)}` : `/follow/${encodeURIComponent(target)}`;
          try {
            const res = await fetch(url, { method: 'POST', credentials: 'same-origin', headers: {'X-Requested-With': 'XMLHttpRequest'} });
            if(!res.ok){
              window.location.href = "/profile/" + encodeURIComponent(target);
              return;
            }

            if(following){
              btn.textContent = 'Follow';
              btn.classList.remove('btn-outline-light');
              btn.classList.add('btn-accent');
              btn.dataset.following = '0';
              const c = document.getElementById('followersCount');
              c.textContent = Math.max(0, parseInt(c.textContent || '0', 10) - 1);
              const me = '{{ session.get("user") or "" }}';
              if(me){
                const list = document.getElementById('followersList');
                const links = list.querySelectorAll('a');
                for(const a of links){ if(a.textContent.trim() === me){ a.parentElement.remove(); break; } }
              }
            } else {
              btn.textContent = 'Unfollow';
              btn.classList.remove('btn-accent');
              btn.classList.add('btn-outline-light');
              btn.dataset.following = '1';
              const c = document.getElementById('followersCount');
              c.textContent = (parseInt(c.textContent || '0', 10) + 1).toString();
              const me = '{{ session.get("user") or "" }}';
              if(me){
                const list = document.getElementById('followersList');
                const el = document.createElement('div');
                el.innerHTML = `<a class="list-handle" href="/profile/${encodeURIComponent(me)}">${me}</a>`;
                list.insertBefore(el, list.firstChild);
              }
            }
          } catch(err){
            console.error(err);
            window.location.href = "/profile/" + encodeURIComponent(target);
          }
        }, false);
      })();
    </script>
  </body>
</html>
