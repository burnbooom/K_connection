<!-- templates/chat.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Chat â€” {{ user }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root{
        --bg: #ffffff;
        --panel: #f7f9fb;
        --card: #ffffff;
        --muted: #6b7280; /* gray-500 */
        --text: #0f1724; /* near-black for body text */
        --accent-1: #2563eb; /* blue-600 */
        --accent-2: #06b6d4; /* teal-400 */
        --bubble-me: linear-gradient(90deg,var(--accent-2),var(--accent-1));
        --bubble-them: #f1f5f9; /* light gray bubble */
        --border: rgba(15,23,36,0.06);
      }
      html,body { height:100%; }
      body {
        margin:0;
        background:var(--bg);
        color:var(--text);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        -webkit-font-smoothing:antialiased;
      }

      .wrap { max-width:1100px; margin:18px auto; padding:0 12px; display:flex; gap:16px; }
      .panel-left { width:320px; min-width:240px; }
      .panel-main { flex:1; display:flex; flex-direction:column; min-height:72vh; }

      .card { background:var(--card); border:1px solid var(--border); border-radius:10px; box-shadow: 0 1px 2px rgba(15,23,36,0.03); }

      /* header */
      .chat-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; }
      .chat-header .title { display:flex; gap:12px; align-items:center; }
      .avatar {
        width:44px; height:44px; border-radius:10px;
        background:linear-gradient(135deg,var(--accent-2),var(--accent-1));
        display:inline-grid; place-items:center; font-weight:700; color:#021018;
      }
      .title .name { font-weight:700; color:var(--text); }
      .title .sub { font-size:0.85rem; color:var(--muted); }

      /* messages area */
      .msgs { padding:16px; overflow:auto; display:flex; flex-direction:column; gap:12px; background:transparent; }
      .msg-row { display:flex; gap:10px; align-items:flex-end; max-width:85%; }
      .msg-row.me { margin-left:auto; justify-content:flex-end; }
      .bubble {
        padding:10px 14px; border-radius:14px; line-height:1.25; word-break:break-word;
        box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
      }
      .bubble.me { background:var(--bubble-me); color:#021018; border-bottom-right-radius:6px; }
      .bubble.them { background:var(--bubble-them); color:var(--text); border-bottom-left-radius:6px; }

      .meta { font-size:0.78rem; color:var(--muted); margin-top:6px; }
      .meta .sender { font-weight:700; color:var(--accent-1); margin-right:8px; }

      /* composer */
      .composer { display:flex; gap:8px; padding:12px; align-items:flex-end; border-top:1px solid rgba(15,23,36,0.04); background:var(--panel); border-radius:0 0 10px 10px; }
      .composer textarea {
        flex:1; min-height:56px; max-height:160px; resize:none;
        border-radius:10px; padding:10px 12px; background:#ffffff;
        color:var(--text); border:1px solid rgba(15,23,36,0.08);
      }
      .composer textarea::placeholder { color: rgba(15,23,36,0.45); }

      .btn-send { min-width:110px; border-radius:10px; background:var(--bubble-me); color:#021018; font-weight:700; border:none; padding:8px 12px; }
      .btn-attach { background:transparent; border:1px dashed rgba(15,23,36,0.06); color:var(--muted); padding:6px 8px; border-radius:8px; }

      /* left list (recent chats + profile summary) */
      .summary { padding:12px; display:flex; gap:10px; align-items:center; }
      .summary .mini { width:44px; height:44px; border-radius:8px; background:linear-gradient(135deg,var(--accent-2),var(--accent-1)); display:grid; place-items:center; color:#032126; font-weight:700; }
      .recent-list { max-height:56vh; overflow:auto; padding:10px; }
      .recent-item { display:flex; justify-content:space-between; align-items:flex-start; padding:8px; border-radius:8px; cursor:pointer; }
      .recent-item:hover { background:rgba(15,23,36,0.02); }
      .recent-item .who { font-weight:700; color:var(--text); }
      .recent-item .preview { color:var(--muted); font-size:0.9rem; margin-top:4px; }

      /* small helpers */
      .small { font-size:0.85rem; color:var(--muted); }
      .text-reset { color:inherit; }

      /* responsive */
      @media (max-width:900px){
        .wrap{ flex-direction:column; }
        .panel-left{ width:100%; order:2; }
        .panel-main{ order:1; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- left column: profile + recent chats -->
      <div class="panel-left">
        <div class="card mb-3">
          <div class="summary">
            <div class="mini">{{ user[1:] if user.startswith('@') else user | upper }}</div>
            <div>
              <div class="who" style="font-weight:800; color:var(--text)">{{ user }}</div>
              <div class="preview small" style="margin-top:4px">{{ (session.get('user') == user) and 'This is you' or 'Private conversation' }}</div>
            </div>
            <div style="margin-left:auto">
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('profile', user=user) }}">Profile</a>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div style="padding:12px; border-bottom:1px solid rgba(15,23,36,0.04); display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700">Recent chats</div>
            <div class="small">{{ recent_chats | length if recent_chats is defined else 0 }}</div>
          </div>

          <div class="recent-list">
            {% if recent_chats %}
              {% for c in recent_chats %}
                <a href="{{ url_for('chat', user=c.user) }}" class="d-block text-decoration-none text-reset">
                  <div class="recent-item">
                    <div style="flex:1;">
                      <div class="who">{{ c.user }}</div>
                      <div class="preview">{{ c.preview }}</div>
                    </div>
                    <div class="small" style="color:var(--muted)">{{ c.last_time or '' }}</div>
                  </div>
                </a>
              {% endfor %}
            {% else %}
              <div style="padding:12px; color:var(--muted)">No recent chats â€” start a conversation from a profile</div>
            {% endif %}
          </div>
        </div>

        <div class="card p-3">
          <div style="font-weight:700; margin-bottom:8px">Shortcuts</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('feed') }}">Back to feed</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('profile', user=session.get('user')) }}">My profile</a>
          </div>
        </div>
      </div>

      <!-- main chat panel -->
      <div class="panel-main card d-flex flex-column">
        <div class="chat-header">
          <div class="title">
            <div class="avatar">{{ user[1] if user.startswith('@') and user|length>1 else (user[0] if user else '?') }}</div>
            <div>
              <div class="name">{{ user }}</div>
              <div class="sub">Private message Â· {{ messages | length if messages is defined else 0 }} messages</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('profile', user=user) }}">View profile</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('feed') }}">Feed</a>
          </div>
        </div>

        <div id="msgs" class="msgs" role="log" aria-live="polite" aria-atomic="false">
          {% if messages %}
            {% for m in messages %}
              {% set is_me = (m.sender == session.get('user')) %}
              <div class="msg-row {% if is_me %}me{% endif %}">
                {% if not is_me %}
                  <div style="min-width:44px">
                    <div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent-2),var(--accent-1));display:grid;place-items:center;color:#032126;font-weight:700;">
                      {{ m.sender[1:] if m.sender.startswith('@') else m.sender[:1] }}
                    </div>
                  </div>
                {% endif %}
                <div>
                  <div class="bubble {% if is_me %}me{% else %}them{% endif %}">{{ m.text | e }}</div>
                  <div class="meta">
                    {% if m.time %}<span class="time">{{ m.time }}</span>{% endif %}
                    {% if not is_me %}<span class="sender"> Â· {{ m.sender }}</span>{% endif %}
                  </div>
                </div>
                {% if is_me %}
                  <div style="min-width:44px"></div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div style="padding:16px; color:var(--muted)">No messages yet. Say hi.</div>
          {% endif %}
        </div>

        <form id="sendForm" class="composer" method="post" action="{{ url_for('send_message') }}">
          <input type="hidden" name="to" value="{{ user }}" />
          <input id="csrf_dummy" type="hidden" value="1" />
          <textarea id="msgText" name="text" placeholder="Write a private messageâ€¦" autocomplete="off" aria-label="Message"></textarea>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <label class="btn-attach btn btn-sm" title="Attach image (not uploaded)">ðŸ“Ž</label>
            <button type="submit" class="btn-send">Send</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      (function(){
        const msgs = document.getElementById('msgs');
        function scrollBottom(){ msgs.scrollTop = msgs.scrollHeight; }
        scrollBottom();

        // auto-scroll if new content height increases
        let lastH = msgs.scrollHeight;
        setInterval(function(){
          if(msgs.scrollHeight !== lastH){
            lastH = msgs.scrollHeight;
            scrollBottom();
          }
        }, 700);

        // send via fetch for snappier UX; fallback to normal form submit
        const form = document.getElementById('sendForm');
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const ta = document.getElementById('msgText');
          const text = ta.value.trim();
          if(!text) return;
          const to = form.querySelector('input[name="to"]').value;
          try {
            const fd = new FormData();
            fd.append('to', to);
            fd.append('text', text);
            const res = await fetch(form.action, {
              method: 'POST',
              body: fd,
              credentials: 'same-origin',
              headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            if(res.ok){
              // optimistic append
              const me = "{{ session.get('user') or '' }}";
              const wrapper = document.createElement('div');
              wrapper.className = 'msg-row me';
              wrapper.innerHTML = `<div></div><div><div class="bubble me">${escapeHtml(text)}</div><div class="meta"><span class="time">Now</span><span class="sender"> Â· ${me}</span></div></div><div style="min-width:44px"></div>`;
              msgs.appendChild(wrapper);
              ta.value = '';
              scrollBottom();
            } else {
              form.submit();
            }
          } catch(err){
            console.error(err);
            form.submit();
          }
        }, false);

        function escapeHtml(s){
          return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#39;');
        }
      })();
    </script>
  </body>
</html>
